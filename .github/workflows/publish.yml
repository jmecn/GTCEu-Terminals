name: Publish (Modrinth + CurseForge)

on:
  release:
    types: [published]

env:
  JAVA_VERSION: 17
  MINECRAFT_VERSION: 1.20.1

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: gradle

      - name: Make gradlew executable
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew clean build -Pmod_version=${{ github.event.release.tag_name }}

      - name: Verify JAR exists
        run: |
          JAR_COUNT=$(find build/libs -name "*.jar" ! -name "*-dev.jar" ! -name "*-sources.jar" ! -name "*-javadoc.jar" | wc -l)
          if [ "$JAR_COUNT" -eq 0 ]; then
            echo "ERROR: No JAR file found!"
            exit 1
          fi
          echo "Found $JAR_COUNT JAR file(s)"
          ls -lh build/libs/*.jar

      - name: Publish to Modrinth
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: ${{ secrets.MODRINTH_PROJECT_ID }}
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}

          files: |
            build/libs/!(*-@(dev|sources|javadoc)).jar

          loaders: forge
          game-versions: ${{ env.MINECRAFT_VERSION }}

          version: ${{ github.event.release.tag_name }}
          name: ${{ github.event.release.name }}
          changelog: ${{ github.event.release.body }}

          version-type: release

          modrinth-dependencies: |
            gregtechceu-modern(required){modrinth:3dT8kQix}
            ldlib(required){modrinth:gSdYOajW}

          retry-attempts: 3
          retry-delay: 10000
          fail-mode: fail

      - name: Upload JAR to GitHub Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: build/libs/!(*-@(dev|sources|javadoc)).jar